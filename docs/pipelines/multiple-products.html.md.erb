# Operations Manager & Multiple products

Below you will find a reference pipeline that illustrates the tasks and provides an example of a basic pipeline design. You know your environment and constraints and we don't - we recommend you look at the tasks that make up the pipeline, and see how they can be arranged for your specific automation needs. For a deeper dive into each task see the Task Reference.

These Concourse pipelines are examples on how to use the [tasks](../tasks.html). If you use a different CI/CD platform, you can use these Concourse files as examples of the inputs, outputs, and arguments used in each step in the workflow.

## Prerequisites

* Deployed Concourse

<p class="note">
<span class="note__title">Note</span>
Platform Automation Toolkit is based on Concourse CI.
We recommend that you have some familiarity with Concourse before getting started.
If you are new to Concourse, see the <a href="https://docs.vmware.com/en/Concourse-for-VMware-Tanzu/index.html">Concourse CI Tutorials</a>.</p>

* Persisted datastore that can be accessed by Concourse resource (for example, s3, gcs, minio)
* A valid [env-file](../how-to-guides/configuring-env.md#generating-an-env-file): this file will contain credentials necessary to login to Operations Manager using the `om` CLI.
It is used by every task within Platform Automation Toolkit
* A valid [auth-file](../how-to-guides/configuring-auth.md#generating-an-auth-file): this file will contain the credentials necessary to create the Operations Manager login the first time
the VM is created. The choices for this file are simple or SAML authentication.

    <p class="note">
    <span class="note__title">Note</span>
    There will be some crossover between the auth file and the env file due to how om is setup and how the system works. It is highly recommended to parameterize these values, and let a credential management system (such as CredHub) fill in these values for you to maintain consistency across files.</p>

* An [opsman-configuration](../inputs-outputs.html#ops-manager-config) file: This file is required to connect to an IAAS, and control the lifecycle management
 of the Operations Manager VM
* A [director-configuration](../how-to-guides/creating-a-director-config-file.html) file: Each Operations Manager needs its own configuration, but it is retrieved differently from
a product configuration. This config is used to deploy a new Operations Manager director, or update an existing one.
* A set of valid [product-configuration](../how-to-guides/adding-a-product.html) files: Each product configuration is a yaml file that contains the properties
necessary to configure an Operations Manager product using the `om` tool. This can be used during install or update.
* (Optional) A working [credhub](https://docs.vmware.com/en/VMware-Tanzu-Application-Service/4.0/tas-for-vms/credhub-index.html) setup with its own UAA client and secret.

<p class="note">
<span class="note__title">Note</span>
<b>Retrieving products from Tanzu Network</b>:
Ensure that you have procured the products from Tanzu Network using the
<a href="./resources.html">reference-resources</a>.</p>

## Installing Operations Manager and multiple products

The pipeline shows how to compose the tasks
to install Operations Manager and the Tanzu Application Service and Healthwatch products.
Its dependencies are coming from a trusted git repository,
which can be retrieved using [this pipeline](./resources.html).

### Full Pipeline and Reference Configurations

There is a [git repository](https://github.com/pivotal/docs-platform-automation-reference-pipeline-config)
containing containing the [full pipeline file](https://github.com/pivotal/docs-platform-automation-reference-pipeline-config/blob/develop/pipelines/pipeline.yml),
along with other pipeline and configuration examples.

This can be useful when you want to take
a fully assembled pipeline as a starting point;
the rest of this document covers the sections of the full pipeline in more detail.

## Pipeline Components

### S3 Resources

These can either be uploaded manually or from the [reference resources pipeline](./resources.html).

```yaml

resources:
- name: platform-automation-tasks
  type: s3
  source:
    access_key_id: ((s3_access_key_id))
    secret_access_key: ((s3_secret_access_key))
    region_name: ((s3_region_name))
    bucket: ((s3_pivnet_products_bucket))
    regexp: .*tasks-(.*).zip

- name: platform-automation-image
  type: s3
  source:
    access_key_id: ((s3_access_key_id))
    secret_access_key: ((s3_secret_access_key))
    region_name: ((s3_region_name))
    bucket: ((s3_pivnet_products_bucket))
    regexp: .*image-(.*).tgz

- name: telemetry-collector-binary
  type: s3
  source:
    access_key_id: ((s3_access_key_id))
    secret_access_key: ((s3_secret_access_key))
    region_name: ((s3_region_name))
    bucket: ((s3_pivnet_products_bucket))
    regexp: .*telemetry-(.*).tgz
```
  
<p class="note">
<span class="note__title">Note</span>
<b>Tanzu Application Service [Windows] with S3</b>:
If retrieving <code>pas-windows</code> and <code>pas-windows-stemcell</code> from an S3 bucket,
you must use the built in S3 concourse resource.
This is done in the example above.
The <code>download-product</code> task with <code>SOURCE: s3</code> does not persist meta information
about necessary stemcell for `pas-windows`
because VMware does not distribute the Windows file system.</p>

Alternatively, products may be downloaded using the `download-product` task with
the param `SOURCE` set to `s3|azure|gcs`.
In a job, specify the following task:

```yaml
...
- task: download-pas
  image: platform-automation-image
  file: platform-automation-tasks/tasks/download-product.yml
  params:
    CONFIG_FILE: download-product-configs/pas.yml
    SOURCE: s3
  input_mapping:
    config: interpolated-creds
  output_mapping:
    downloaded-product: pas-product
    downloaded-stemcell: pas-stemcell
...
```

### Exported Installation Resource

<%= partial "export_installation_note" %>

```yaml

- name: installation
  type: s3
  source:
    access_key_id: ((s3_access_key_id))
    secret_access_key: ((s3_secret_access_key))
    region_name: ((s3_region_name))
    bucket: ((s3_installation_bucket))
    regexp: ((foundation))-installation-(.*).zip
```

### Configured Resources

These contain values for
opsman VM creation, director, product, foundation-specific vars, auth, and env files.
For more details, see the [Inputs and Outputs](../inputs-outputs.html) section.
Platform Automation Toolkit will not create these resources for you.

```yaml

# VM state and foundation configuration
- name: state
  type: s3
  source:
    access_key_id: ((s3_access_key_id))
    bucket: ((s3_foundation_state_bucket))
    region_name: ((s3_region_name))
    secret_access_key: ((s3_secret_access_key))
    versioned_file: state-((foundation)).yml
    initial_content_text: '{}'
    initial_version: 'empty-start'

# configurations
- name: configuration
  type: git
  source:
    private_key: ((docs-ref-pipeline-repo-key.private_key))
    uri: ((docs-ref-pipeline-repo-uri))
    branch: develop
```

### Trigger Resources

```yaml

# triggers used to have jobs do something in a timely manner
- name: one-time-trigger
  type: time
  source:
    interval: 999999h

- name: daily-trigger
  type: time
  source:
    interval: 24h
```

### Secrets Handling

This helps load secrets stored in an external credential manager -- such as CredHub.
Concourse support several [credential managers](https://concourse-ci.org/creds.html) natively.

The configuration below uses the [`prepare-tasks-with-secrets`](../tasks.html#prepare-tasks-with-secrets) task
to load secrets from your external configuration files.

```yaml
# This task is used in multiple jobs
# The yaml anchor "*prepare-tasks-with-secrets" is used in its place
prepare-tasks-with-secrets: &prepare-tasks-with-secrets
  image: platform-automation-image
  file: platform-automation-tasks/tasks/prepare-tasks-with-secrets.yml
  input_mapping:
    tasks: platform-automation-tasks
    config: configuration
    vars: configuration
  params:
    CONFIG_PATHS: config/foundations/config config/foundations/((foundation))/config
    VARS_PATHS: vars/foundations/((foundation))/vars
  output_mapping:
    tasks: platform-automation-tasks
```

### Jobs

Each job corresponds to a "box"
on the visual representation of your Concourse pipeline.
These jobs consume resources defined above.

<%= partial "reference/reference-jobs" %>
