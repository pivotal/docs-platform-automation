# Task inputs

These are the inputs that can be provided to the tasks.
Each task can only take a specific set, indicated under the `inputs` property of the YAML.

## Inputs

### director config

The config director will set the bosh tile (director) on Operations Manager.

The `config` input for a director task expects to have a `director.yml` file.
The configuration of the `director.yml` is IAAS specific for some properties -- i.e. networking.

There are two ways to build a director config.

1. Using an already deployed Operations Manager, you can extract the config using [staged-director-config].
2. Deploying a brand new Operations Manager requires more effort for a `director.yml`.
   The configuration of director is variables based on the features enabled.
   For brevity, this `director.yml` is a basic example for vsphere.

<%= partial "examples/director" %>

The IAAS specific configuration can be found in the Operations Manager API documentation.

Included below is a list of properties that can be set in the `director.yml`
and a link to the API documentation explaining any IAAS specific properties.

* `az-configuration` - a list of availability zones [Operations Manager API][opsman-api-azs]
* `network-assignment` - the network the bosh director is deployed to [Operations Manager API][opsman-api-network-az-assignment]
* `networks-configuration` - a list of named networks [Operations Manager API][opsman-api-networks]
* `properties-configuration`
    * `iaas_configuration` - configuration for the bosh IAAS CPI [Operations Manager API][opsman-api-director-properties]
    * `director_configuration` - properties for the bosh director [Operations Manager API][opsman-api-director-properties]
    * `security_configuration` - security properties for the bosh director [Operations Manager API][opsman-api-director-properties]
    * `syslog_configuration` - configure the syslog sinks for the bosh director [Operations Manager API][opsman-api-director-properties]
* `resource-configuration` - IAAS VM flavor for the bosh director [Operations Manager API][opsman-api-config-resources]
* `vmextensions-configuration` - create/update/delete VM extensions [Operations Manager API][opsman-api-vm-extension]

#### GCP Shared VPC

Support for Shared VPC is done via configuring the `iaas_identifier` path for the [infrastructure subnet][gcp-create-network],
which includes the host project id, region of the subnet, and the subnet name.

For example:

`[HOST_PROJECT_ID]/[NETWORK]/[SUBNET]/[REGION]`

### download-product-config

The `config` input for a download product task 
can be used with a `download-config.yml` file to download a tile.
The configuration of the `download-config.yml` looks like this:

**Tanzu Network**

```yaml
---
pivnet-api-token: token
pivnet-file-glob: "*.pivotal"       # must be quoted if starting with a *
pivnet-product-slug: product-slug

# Either product-version OR product-version-regex is required
# product-version-regex: ^1\.2\..*$ # must not be quoted
product-version: 1.2.3

# Optional
# pivnet-disable-ssl: true  # default - false
# stemcell-iaas: aws        # aws|azure|google|openstack|vsphere
                            # will attempt to download the latest stemcell
                            # associated with a product by default
# stemcell-version: 90.90   # specific stemcell version to download
# stemcell-heavy: true      # will force download of heavy stemcell
                            # not available on all IaaSes
# blobstore-bucket: bucket  # if set, product files will have their slug and
                            # version prepended. Set if the product will
                            # ever be stored in a blobstore
```

**S3**

```yaml
---
pivnet-file-glob: "*.pivotal"       # must be quoted if starting with a *
pivnet-product-slug: product-slug
blobstore-bucket: bucket-name
s3-region-name: us-west-1           # if NOT using AWS s3, value is 'region'

## Required unless `s3-auth-type: iam`
s3-access-key-id: aws-or-minio-key-id
s3-secret-access-key: aws-or-minio-secret-key

# Optional
# blobstore-product-path: /path/to/product    # default - root path of bucket
# blobstore-stemcell-path: /path/to/stemcell  # default - root path of bucket
# s3-disable-ssl: true                        # default - false
# s3-enable-v2-signing: true                  # available for compatibility
# s3-auth-type: iam                           # default - accesskey
# s3-endpoint: s3.endpoint.com                # required if NOT using AWS S3
```

**GCS**

```yaml
---
pivnet-file-glob: "*.pivotal"       # must be quoted if starting with a *
pivnet-product-slug: product-slug
blobstore-bucket: bucket-name
gcs-project-id: project-id
gcs-service-account-json: |
  {
    "type": "service_account",
    "project_id": "project-id",
    "private_key_id": "fake-key-id",
    "private_key": "-----BEGIN PRIVATE KEY-----\fake-key-----END PRIVATE KEY-----\n",
    "client_email": "email@project-id.iam.gserviceaccount.com",
    "client_id": "123456789876543212345",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://accounts.google.com/o/oauth2/token",
    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
    "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/project%40project-id.iam.gserviceaccount.com"
  }

# Optional
# blobstore-product-path: /path/to/product    # default - root path of bucket
# blobstore-stemcell-path: /path/to/stemcell  # default - root path of bucket
```

**Azure**

```yaml
---
pivnet-file-glob: "*.pivotal"       # must be quoted if starting with a *
pivnet-product-slug: product-slug
blobstore-bucket: container-name
azure-storage-account: 1234567890abcdefghij
azure-storage-key: storage-access-key-from-azure-portal

# Optional
# blobstore-product-path: /path/to/product    # default - root path of bucket
# blobstore-stemcell-path: /path/to/stemcell  # default - root path of bucket
```

### download-stemcell-product-config

The `config` input for a download product task 
can be used with a `download-config.yml` file to download a stemcell.
The configuration of the `download-config.yml` looks like this:

<%= partial "download-stemcell-product" %>

### env

The `env` input for a task expects to have a `env.yml` file.
This file contains properties for targeting and logging into the Operations Manager API.

**basic auth**

<%= partial "examples/env" %>

**uaa auth**

<%= partial "examples/env-uaa" %>

#### Getting the `client-id` and `client-secret`

Operations Manager will by preference use Client ID and Client Secret if provided.
To create a Client ID and Client Secret

1. `uaac target https://YOUR_OPSMANAGER/uaa`
1. `uaac token sso get` if using SAML or `uaac token owner get` if using basic auth. Specify the Client ID as `opsman` and leave Client Secret blank.
1. Generate a client ID and secret

```bash
uaac client add -i
Client ID:  NEW_CLIENT_NAME
New client secret:  DESIRED_PASSWORD
Verify new client secret:  DESIRED_PASSWORD
scope (list):  opsman.admin
authorized grant types (list):  client_credentials
authorities (list):  opsman.admin
access token validity (seconds):  43200
refresh token validity (seconds):  43200
redirect uri (list):
autoapprove (list):
signup redirect url (url):
```
### installation

The file contains the information to restore an Operations Manager VM.
The `installation` input for a opsman VM task expects to have a `installation.zip` file.

This file can be exported from an Operations Manager VM using the [export-installation][export-installation].
This file can be imported to an Operations Manager VM using the [import-installation][import-installation].

<p class="note important">
<span class="note__title">Important</span>
This file cannot be manually created. It is a file that must be generated using the export function of Operations Manager.</p>

### Operations Manager config
The config for an Operations Manager described IAAS specific information for creating the VM; that is, the VM flavor (size) and IP addresses.

The `config` input for opsman task expects to have a `opsman.yml` file.
The configuration of the `opsman.yml` is IAAS specific.

**AWS**

<%= partial "examples/opsman-config/aws" %>

**Azure**

<%= partial "examples/opsman-config/azure" %>

**GCP**

<%= partial "examples/opsman-config/gcp" %>

**OpenStack**

<%= partial "examples/opsman-config/openstack" %>

**vSphere**

<%= partial "examples/opsman-config/vsphere" %>

**Additional Settings**

<%= partial "examples/opsman-config/settings" %>

Specific advice and features for the different IaaSs are documented below.

#### AWS
These required properties are adapted from the instructions outlined in
[Launching an Operations Manager Director Instance on AWS][manual-aws]

<%= partial "ip-addresses" %>

<p class="note important">
<span class="note__title">Important</span>
<b>Using instance_profile to avoid secrets</b>:
For authentication you must either set <code>use_instance_profile: true</code>
or provide a <code>secret_key_id</code> and <code>secret_access_key</code>.
You must remove key information if you're using an instance profile.
Using an instance profile allows you to avoid interpolation,
as this file then contains no secrets.</p>

#### Azure
The required properties are adapted from the instructions outlined in
[Launching an Operations Manager Director Instance on Azure][manual-azure]

<%= partial "ip-addresses" %>

#### GCP
The required properties are adapted from the instructions outlined in
[Launching an Operations Manager Director Instance on GCP][manual-gcp]

<%= partial "ip-addresses" %>

<p class="note important">
<span class="note__title">Important</span>
<b>Using a service account Name to avoid secrets</b>:
For authentication either <code>gcp_service_account</code> or <code>gcp_service_account_name</code> is required.
You must remove the one you are not using
note that using <code>gcp_service_account_name</code> allows you to avoid interpolation,
as this file then contains no secrets.</p>

Support for Shared VPC is done via
[configuring the `vpc_subnet` path][gcp-shared-vpc]
to include the host project id, region of the subnet, and the subnet name.

For example:

`projects/[HOST_PROJECT_ID]/regions/[REGION]/subnetworks/[SUBNET]`

#### Openstack

The required properties are adapted from the instructions outlined in
[Launching an Operations Manager Director Instance on Openstack][manual-openstack]

<%= partial "ip-addresses" %>

#### vSphere

The required properties are adapted from the instructions outlined in
[Deploying BOSH and Operations Manager to vSphere][manual-vsphere]

### opsman image

This file is an [artifact from Tanzu Network](https://network.pivotal.io/products/ops-manager),
which contains the VM image for a specific IaaS.
For vsphere and openstack, it's a full disk image.
For AWS, GCP, and Azure, it's a YAML file listing the location
of images that are already available on the IaaS.

These are examples to download the image artifact for each IaaS
using the [download-product][download-product] task.

#### opsman.yml

<%= partial "how-to-guides/opsman-config-tabs" %>

The `p-automator` CLI includes the ability to extract the Operations Manager VM configuration (GCP, AWS, Azure, and VSphere).
This works for Operations Managers that are already running and useful when [migrating to automation][upgrade-how-to].

Usage:

1. Get the Platform Automation Toolkit image from Tanzu Network.
2. Import that image into `docker` to run the [`p-automation` locally][running-commands-locally].
3. Create a [state file][state] that represents your current VM and IAAS.
4. Invoke the `p-automator` CLI to get the configuration.

For example, on AWS with an access key and secret key:

```bash
docker run -it --rm -v $PWD:/workspace -w /workspace platform-automation-image \
p-automator export-opsman-config \
--state-file=state.yml \
--aws-region=us-west-1 \
--aws-secret-access-key some-secret-key \
--aws-access-key-id some-access-key
```

The outputted `opsman.yml` contains the information needed for Platform Automation Toolkit to manage the Operations Manager VM.

#### download-product task

```yaml
- task: download-opsman-image
  image: platform-automation-image
  file: platform-automation-tasks/tasks/download-product.yml
  params:
    CONFIG_FILE: opsman.yml
```

### product

The `product` input requires a single tile file (`.pivotal`) as downloaded from Tanzu Network.

Here's an example of how to pull the Tanzu Application Service tile
using the [download-product][download-product] task.

#### product.yml

```yaml
---
pivnet-api-token: token
pivnet-file-glob: "cf-*.pivotal"
pivnet-product-slug: elastic-runtime
product-version-regex: ^2\.6\..*$
```

#### download-product task

```yaml
- task: download-stemcell
  image: platform-automation-image
  file: platform-automation-tasks/tasks/download-product.yml
  params:
    CONFIG_FILE: product.yml
```

<p class="note important">
<span class="note__title">Important</span>
This file cannot be manually created. This file must retrieved from Tanzu Network.</p>
    
### product config

There are two ways to build a product config.

1. Using an already deployed product (tile), you can extract the config using [staged-config].
1. Use an example and fill in the values based on the meta information from the tile.
For brevity, this `product.yml` is a basic example for `healthwatch`.

<%= partial "examples/product" %>

Included below is a list of properties that can be set in the `product.yml`
and a link to the API documentation explaining the properties.

* `product-properties` - properties for the tile [Operations Manager API][opsman-api-config-products]
* `network-properties` - a list of named networks to deploy the VMs to [Operations Manager API][opsman-api-config-networks]
* `resource-config` - for the jobs of the tile [Operations Manager API][opsman-api-config-resources]

### state

This file contains that meta-information needed to manage the Operations Manager VM.
The `state` input for a opsman VM task expects to have a `state.yml` file.

The `state.yml` file contains two properties:

1. `iaas` is the IAAS the ops manager VM is hosted on. (`gcp`, `vsphere`, `aws`, `azure`, `openstack`)
2. `vm_id` is the VM unique identifier for the VM. For some IAAS, the VM ID is the VM name.

Different IaaS uniquely identify VMs differently;
here are examples for what this file should look like,
depending on your IAAS:

**AWS**
    ``` yaml
    --8<-- 'docs/examples/state/aws.yml'
    ```

**Azure**
    ``` yaml
    --8<-- 'docs/examples/state/azure.yml'
    ```

**GCP**
    ``` yaml
    --8<-- 'docs/examples/state/gcp.yml'
    ```

**OpenStack**
    ``` yaml
    --8<-- 'docs/examples/state/openstack.yml'
    ```

**vSphere**
    ``` yaml
    --8<-- 'docs/examples/state/vsphere.yml'
    ```

### stemcell
This `stemcell` input requires the stemcell tarball (`.tgz`) as downloaded from Tanzu Network.
It must be in the original filename as that is used by Operations Manager to parse metadata.
The filename could look like `bosh-stemcell-3541.48-vsphere-esxi-ubuntu-trusty-go_agent.tgz`.

<p class="note important">
<span class="note__title">Important</span>
This file cannot be manually created. This file must retrieved from Tanzu Network.</p>

Here's an example of how to pull the vSphere stemcell
using the [download-product][download-product] task.

#### stemcell.yml

**AWS"
    ```yaml
    ---
    pivnet-api-token: token
    pivnet-file-glob: "bosh-stemcell-*-aws*.tgz"
    pivnet-product-slug: stemcells-ubuntu-xenial
    prod    uct-version-regex: ^170\..*$
    ```

**Azure"
    ```yaml
    ---
    pivnet-api-token: token
    pivnet-file-glob: "bosh-stemcell-*-azure*.tgz"
    pivnet-product-slug: stemcells-ubuntu-xenial
    product-version-regex: ^170\..*$
    ```

**GCP"
    ```yaml
    ---
    pivnet-api-token: token
    pivnet-file-glob: "bosh-stemcell-*-google*.tgz"
    pivnet-product-slug: stemcells-ubuntu-xenial
    product-version-regex: ^170\..*$
    ```

**OpenStack"
    ```yaml
    ---
    pivnet-api-token: token
    pivnet-file-glob: "bosh-stemcell-*-openstack*.tgz"
    pivnet-product-slug: stemcells-ubuntu-xenial
    product-version-regex: ^170\..*$
    ```

**vSphere"
    ```yaml
    ---
    pivnet-api-token: token
    pivnet-file-glob: "bosh-stemcell-*-vsphere*.tgz"
    pivnet-product-slug: stemcells-ubuntu-xenial
    product-version-regex: ^170\..*$
    ```


#### download-product task

```yaml
- task: download-stemcell
  image: platform-automation-image
  file: platform-automation-tasks/tasks/download-product.yml
  params:
    CONFIG_FILE: stemcell.yml
```

#### assign-stemcell-task
This artifact is an output of [`download-product`][download-product]
located in the `assign-stemcell-config` output directory.

This file should resemble the following:
```yaml
product: cf
stemcell: "97.190"
```

### telemetry

The `config` input for the [collect-telemetry][collect-telemetry] task 
can be used with a `telemetry.yml` file to collect data for VMware
so they can learn and measure results 
in order to put customer experience at the forefront of their product decisions.
The configuration of the `telemetry.yml` looks like this:

<%= partial "examples/telemetry" %>
